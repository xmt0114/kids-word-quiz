# 设计文档

## 概述

本设计文档描述了对 `supabaseApi.ts` 中 `getWords` 方法的清理和简化。当前方法包含复杂的逻辑分支，包括随机选择策略和对已删除RPC的调用。简化后的方法将专注于数据管理页面的核心需求：基本排序和分页功能。

## 架构

### 当前架构问题
- `getWords` 方法包含多个选择策略（sequential, random）
- 调用已删除的 `get_random_words` RPC
- 复杂的条件逻辑处理不同的使用场景
- 参数过多，部分已不再使用

### 目标架构
- 简化的方法签名，只保留数据管理所需参数
- 移除所有随机选择逻辑
- 统一的查询构建逻辑
- 清晰的错误处理

## 组件和接口

### 简化后的方法签名
```typescript
async getWords(filters?: {
  collectionId?: string;
  limit?: number;
  offset?: number;
  sortBy?: 'word' | 'created_at';
  sortOrder?: 'asc' | 'desc';
}): Promise<WordApiResponse>
```

### 移除的参数
- `selectionStrategy`: 不再需要随机选择
- 复杂的条件逻辑分支

### 保留的核心功能
- 教材集合过滤
- 基本排序（按单词或创建时间）
- 分页支持（limit/offset）
- 错误处理

## 数据模型

### 输入参数模型
```typescript
interface GetWordsFilters {
  collectionId?: string;    // 教材集合ID，默认使用DEFAULT_COLLECTION_ID
  limit?: number;           // 每页数量，默认20
  offset?: number;          // 偏移量，默认0
  sortBy?: 'word' | 'created_at';  // 排序字段，默认'word'
  sortOrder?: 'asc' | 'desc';      // 排序方向，默认'asc'
}
```

### 输出数据模型
保持现有的 `WordApiResponse` 格式不变，确保向后兼容性。

## 正确性属性

*属性是应该在系统的所有有效执行中保持为真的特征或行为——本质上是关于系统应该做什么的正式声明。属性作为人类可读规范和机器可验证正确性保证之间的桥梁。*

### 属性 1: 向后兼容性保持
*对于任何*现有的数据管理页面调用模式，重构后的方法应该返回与重构前相同的结果
**验证: 需求 1.4**

### 属性 2: 排序字段正确性
*对于任何*指定的sortBy字段（'word'或'created_at'），返回的单词列表应该按该字段正确排序
**验证: 需求 2.1**

### 属性 3: 排序方向一致性
*对于任何*相同的数据集，升序和降序排序的结果应该是相反的顺序
**验证: 需求 2.2**

### 属性 4: 分页数据完整性
*对于任何*分页请求，不同页面的数据不应重复，且所有页面的数据总和应等于完整数据集
**验证: 需求 2.3**

### 属性 5: 集合过滤准确性
*对于任何*指定的教材集合ID，返回的所有单词都应该属于该集合
**验证: 需求 2.4**

### 属性 6: 默认值行为一致性
*对于任何*未提供的可选参数，系统应该使用预定义的默认值，且行为应该与显式提供默认值时一致
**验证: 需求 2.5, 3.2**

## 错误处理

### 参数验证
- 验证 `sortBy` 字段只能是 'word' 或 'created_at'
- 验证 `sortOrder` 只能是 'asc' 或 'desc'
- 验证 `limit` 和 `offset` 为非负整数

### 数据库错误处理
- 保持现有的错误处理模式
- 提供清晰的错误消息
- 记录详细的错误日志

## 测试策略

### 单元测试
- 测试参数验证逻辑
- 测试默认值设置
- 测试错误情况处理
- 测试SQL查询构建

### 属性测试
使用 **fast-check** 作为属性测试库，每个属性测试运行最少100次迭代。

每个属性测试必须使用以下格式标记：
`**Feature: getwords-method-cleanup, Property {number}: {property_text}**`

- **属性 1**: 测试向后兼容性 - 使用现有调用模式验证结果一致性
- **属性 2**: 测试排序正确性 - 生成随机单词数据，验证排序结果
- **属性 3**: 测试排序方向 - 验证升序降序结果的相反性
- **属性 4**: 测试分页完整性 - 验证分页数据的完整性和一致性
- **属性 5**: 测试集合过滤 - 验证返回数据的集合归属
- **属性 6**: 测试默认值 - 验证默认参数行为的一致性

### 集成测试
- 测试与数据管理页面的集成
- 测试实际数据库操作
- 测试性能影响

## 实现计划

### 阶段1: 代码清理
1. 移除 `selectionStrategy` 相关逻辑
2. 删除 `get_random_words` RPC调用
3. 简化条件分支

### 阶段2: 方法重构
1. 更新方法签名
2. 实现统一的查询构建逻辑
3. 添加参数验证

### 阶段3: 测试和验证
1. 编写单元测试
2. 实现属性测试
3. 验证数据管理页面功能

### 阶段4: 文档更新
1. 更新方法注释
2. 更新API文档
3. 添加使用示例