<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>新单词API功能测试指南</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #f5f7fa;
    }
    h1 {
      color: #1a365d;
      border-bottom: 3px solid #3182ce;
      padding-bottom: 10px;
    }
    h2 {
      color: #2c5282;
      margin-top: 30px;
    }
    .test-case {
      background: white;
      border-radius: 8px;
      padding: 20px;
      margin: 20px 0;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .step {
      background: #f7fafc;
      padding: 15px;
      margin: 10px 0;
      border-left: 4px solid #3182ce;
      border-radius: 4px;
    }
    .code {
      background: #2d3748;
      color: #e2e8f0;
      padding: 15px;
      border-radius: 6px;
      font-family: 'Courier New', monospace;
      overflow-x: auto;
    }
    .success {
      color: #22543d;
      background: #f0fff4;
      padding: 10px;
      border-radius: 4px;
      border-left: 4px solid #48bb78;
    }
    .error {
      color: #742a2a;
      background: #fff5f5;
      padding: 10px;
      border-radius: 4px;
      border-left: 4px solid #f56565;
    }
    .warning {
      color: #744210;
      background: #fffaf0;
      padding: 10px;
      border-radius: 4px;
      border-left: 4px solid #ed8936;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    th, td {
      border: 1px solid #e2e8f0;
      padding: 12px;
      text-align: left;
    }
    th {
      background: #edf2f7;
      font-weight: bold;
    }
    .highlight {
      background: #fef5e7;
      padding: 15px;
      border-left: 4px solid #f59e0b;
      margin: 15px 0;
    }
    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: bold;
      margin-left: 8px;
    }
    .badge-new {
      background: #48bb78;
      color: white;
    }
    .badge-updated {
      background: #4299e1;
      color: white;
    }
    .badge-unchanged {
      background: #a0aec0;
      color: white;
    }
  </style>
</head>
<body>
  <h1>🧪 新单词API功能测试指南</h1>

  <div class="highlight">
    <strong>📋 测试目的：</strong>验证数据管理页面的新RPC函数（add_single_word、add_batch_words）是否正常工作。
  </div>

  <h2>🐛 重要修复说明</h2>
  <div class="test-case">
    <h3>已修复的问题</h3>
    <div class="warning">
      <strong>问题：</strong> 批量添加单词时出现错误<br>
      <span class="code">"code": "22023", "message": "cannot call jsonb_to_recordset on a non-array"</span>
    </div>
    <div class="success">
      <strong>解决方案：</strong><br>
      原因：RPC函数期望接收数组对象，但代码传递了JSON字符串<br>
      修复：将 <code>p_words_batch: JSON.stringify(batchData)</code> 改为 <code>p_words_batch: batchData</code><br>
      说明：Supabase V2 客户端支持直接传递数组对象，无需JSON.stringify
    </div>
    <div class="step">
      <strong>修复状态：</strong> ✅ 已完成并验证编译通过<br>
      <strong>验证方式：</strong> 开发服务器热更新已应用修改
    </div>
  </div>

  <h2>📍 测试环境</h2>
  <div class="step">
    <strong>URL：</strong> http://localhost:5175<br>
    <strong>入口：</strong> 数据管理页面<br>
    <strong>权限：</strong> 需要管理员权限
  </div>

  <h2>✅ 测试用例1：单条添加单词</h2>
  <div class="test-case">
    <h3>测试步骤</h3>

    <div class="step">
      <strong>步骤1：</strong> 打开数据管理页面<br>
      <span class="code">http://localhost:5175</span><br>
      点击导航栏中的"数据管理"
    </div>

    <div class="step">
      <strong>步骤2：</strong> 选择教材<br>
      在"教材管理"标签页中选择一个教材<br>
      自动跳转到"词汇管理"标签页
    </div>

    <div class="step">
      <strong>步骤3：</strong> 点击"添加词汇"按钮<br>
      位置：词汇管理页面右上角
    </div>

    <div class="step">
      <strong>步骤4：</strong> 填写表单<br>
      <table>
        <tr>
          <th>字段</th>
          <th>示例值</th>
          <th>说明</th>
        </tr>
        <tr>
          <td>单词</td>
          <td>test-word-001</td>
          <td>唯一标识，避免重复</td>
        </tr>
        <tr>
          <td>定义</td>
          <td>这是一个测试单词</td>
          <td>中文释义</td>
        </tr>
        <tr>
          <td>音频文本</td>
          <td>test word</td>
          <td>用于TTS朗读的英文文本</td>
        </tr>
        <tr>
          <td>难度</td>
          <td>easy</td>
          <td>easy / medium / hard</td>
        </tr>
        <tr>
          <td>选项</td>
          <td>选项1, 选项2, 选项3, 选项4</td>
          <td>至少3个选项</td>
        </tr>
        <tr>
          <td>答案</td>
          <td>选项1</td>
          <td>必须与选项之一匹配</td>
        </tr>
        <tr>
          <td>提示</td>
          <td>这是一个提示</td>
          <td>可选字段</td>
        </tr>
      </table>
    </div>

    <div class="step">
      <strong>步骤5：</strong> 点击"保存"按钮提交
    </div>

    <h3>✅ 期望结果</h3>
    <div class="success">
      ✅ 显示成功提示："添加词汇成功"<br>
      ✅ 单词出现在词汇列表中<br>
      ✅ 教材的"词汇数量"自动加1<br>
      ✅ 控制台显示日志：<br>
      <span class="code">[DataManagement] 添加单词: {...}<br>[DataManagement] 添加成功: {...}</span>
    </div>

    <h3>❌ 异常情况</h3>
    <div class="error">
      ❌ 显示错误提示："添加失败: {错误信息}"<br>
      ❌ 控制台显示错误：<br>
      <span class="code">RPC add_single_word error: {错误详情}</span>
    </div>
  </div>

  <h2>✅ 测试用例2：批量添加单词</h2>
  <div class="test-case">
    <h3>测试步骤</h3>

    <div class="step">
      <strong>步骤1-2：</strong> 同单条添加（选择教材）
    </div>

    <div class="step">
      <strong>步骤3：</strong> 点击"批量添加"按钮<br>
      位置：词汇管理页面右上角
    </div>

    <div class="step">
      <strong>步骤4：</strong> 导入批量数据<br>
      可以使用以下格式：<br>
      <span class="code">
Word, Definition, Audio Text, Difficulty, Answer, Hint<br>
banana, 香蕉, banana, easy, banana, 黄色水果<br>
cherry, 樱桃, cherry, medium, cherry, 红色小水果<br>
orange, 橙子, orange, easy, orange, 圆形水果
      </span>
    </div>

    <div class="step">
      <strong>步骤5：</strong> 点击"批量添加"按钮提交
    </div>

    <h3>✅ 期望结果</h3>
    <div class="success">
      ✅ 显示进度提示："正在添加 X 个单词..."<br>
      ✅ 显示成功提示："成功添加 X 个词汇"<br>
      ✅ 所有单词出现在词汇列表中<br>
      ✅ 教材的"词汇数量"增加X<br>
      ✅ 控制台显示日志：<br>
      <span class="code">[DataManagement] 批量添加单词: {...}<br>[DataManagement] 批量添加成功: [...]</span>
    </div>

    <h3>❌ 异常情况</h3>
    <div class="error">
      ❌ 显示错误提示："批量添加失败: {错误信息}"<br>
      ❌ 控制台显示错误：<br>
      <span class="code">RPC add_batch_words error: {错误详情}</span>
    </div>
  </div>

  <h2>⚠️ 测试用例3：错误处理</h2>
  <div class="test-case">
    <h3>3.1 测试必填字段缺失</h3>
    <div class="step">
      <strong>操作：</strong> 提交空字段或无效数据<br>
      <table>
        <tr>
          <th>测试场景</th>
          <th>操作</th>
          <th>期望结果</th>
        </tr>
        <tr>
          <td>空单词</td>
          <td>留空单词字段</td>
          <td class="success">显示验证错误</td>
        </tr>
        <tr>
          <td>空定义</td>
          <td>留空定义字段</td>
          <td class="success">显示验证错误</td>
        </tr>
        <tr>
          <td>空答案</td>
          <td>不填写答案字段</td>
          <td class="warning">使用默认值""（空字符串）</td>
        </tr>
        <tr>
          <td>重复单词</td>
          <td>添加已存在的单词</td>
          <td class="error">显示唯一约束错误</td>
        </tr>
      </table>
    </div>

    <h3>3.2 测试网络错误</h3>
    <div class="step">
      <strong>操作：</strong> 断网或RPC函数不可用<br>
      <strong>期望结果：</strong>
      <div class="error">
        ❌ 显示错误提示："添加失败: RPC函数未找到"或网络错误<br>
        ❌ 数据不会添加到数据库<br>
        ❌ word_count 不会更新
      </div>
    </div>
  </div>

  <h2>📊 测试检查清单</h2>
  <div class="test-case">
    <table>
      <tr>
        <th>测试项</th>
        <th>状态</th>
        <th>备注</th>
      </tr>
      <tr>
        <td>单条添加成功</td>
        <td><input type="checkbox"></td>
        <td>验证添加成功和界面更新</td>
      </tr>
      <tr>
        <td>批量添加成功</td>
        <td><input type="checkbox"></td>
        <td>验证所有单词都添加成功</td>
      </tr>
      <tr>
        <td>word_count 自动更新</td>
        <td><input type="checkbox"></td>
        <td>教材词汇数量正确增加</td>
      </tr>
      <tr>
        <td>数据在列表中显示</td>
        <td><input type="checkbox"></td>
        <td>新添加的单词出现在列表末尾</td>
      </tr>
      <tr>
        <td>控制台日志正确</td>
        <td><input type="checkbox"></td>
        <td>查看控制台是否有预期日志</td>
      </tr>
      <tr>
        <td>错误提示正确显示</td>
        <td><input type="checkbox"></td>
        <td>测试错误场景的错误提示</td>
      </tr>
      <tr>
        <td>可选字段处理正确</td>
        <td><input type="checkbox"></td>
        <td>hint和options为空时默认值正确</td>
      </tr>
      <tr>
        <td>重复数据处理</td>
        <td><input type="checkbox"></td>
        <td>测试重复单词的错误处理</td>
      </tr>
      <tr>
        <td>大量数据处理</td>
        <td><input type="checkbox"></td>
        <td>测试100+个单词的批量添加</td>
      </tr>
    </table>
  </div>

  <h2>🔍 调试技巧</h2>
  <div class="test-case">
    <h3>打开浏览器控制台</h3>
    <div class="step">
      按 <strong>F12</strong> 或右键选择"检查"打开开发者工具<br>
      切换到 <strong>Console</strong> 标签页
    </div>

    <h3>查看网络请求</h3>
    <div class="step">
      切换到 <strong>Network</strong> 标签页<br>
      筛选器中选择 <strong>RPC</strong><br>
      提交表单后查看请求<br>
      点击请求查看详情
    </div>

    <h3>重要日志</h3>
    <div class="code">
[data] - 用户操作日志<br>
[data] RPC add_single_word error - 单条添加错误<br>
[data] RPC add_batch_words error - 批量添加错误<br>
[data] 添加成功 - 单条添加成功<br>
[data] 批量添加成功 - 批量添加成功
    </div>
  </div>

  <h2>📝 常见问题</h2>
  <div class="test-case">
    <h3>Q1: 批量添加失败，只成功了一部分？</h3>
    <div class="warning">
      <strong>A:</strong> 批量添加是原子操作，要么全部成功，要么全部失败。如果部分成功，说明RPC函数可能有问题，请检查控制台错误日志。
    </div>

    <h3>Q2: word_count 没有更新？</h3>
    <div class="warning">
      <strong>A:</strong> word_count 由数据库触发器自动更新。如果没更新，可能是：
      <ul>
        <li>RPC函数执行失败</li>
        <li>数据库触发器未正常工作</li>
        <li>需要刷新页面</li>
      </ul>
    </div>

    <h3>Q3: 新添加的单词没有出现在列表中？</h3>
    <div class="warning">
      <strong>A:</strong> 新单词会添加到数据库末尾。如果当前页不是最后一页，需要手动翻到最后一页查看。
    </div>

    <h3>Q4: 如何测试大数据量？</h3>
    <div class="warning">
      <strong>A:</strong> 可以准备1000+个单词的CSV文件进行批量导入测试。重点观察：
      <ul>
        <li>添加速度是否可接受（应在5秒内完成）</li>
        <li>内存使用是否正常</li>
        <li>是否会出现超时错误</li>
      </ul>
    </div>
  </div>

  <h2>📞 获取支持</h2>
  <div class="test-case">
    <p>如果遇到问题，请：</p>
    <ol>
      <li>查看控制台错误日志</li>
      <li>检查网络请求详情</li>
      <li>记录错误信息</li>
      <li>联系开发团队</li>
    </ol>
  </div>

  <div class="highlight">
    <strong>🎯 预期完成时间：</strong> 30-45分钟<br>
    <strong>💡 建议：</strong> 先测试单条添加，再测试批量添加，最后测试错误处理
  </div>

</body>
</html>
