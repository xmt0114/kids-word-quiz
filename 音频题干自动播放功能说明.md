# 音频题干自动播放功能实现说明

## 功能概述

为答题页面中的音频题干添加了自动播放功能。当用户进入音频题干模式的题目时，系统会自动播放题干内容，提升用户体验。

## 实现细节

### 1. 组件修改

#### TextToSpeechButton.tsx
- 添加了 `TextToSpeechButtonRef` 接口，支持外部调用播放功能
- 使用 `React.forwardRef` 和 `useImperativeHandle` 暴露三个方法：
  - `handlePlay`: 手动播放（会停止当前播放）
  - `autoPlay`: 自动播放（不会停止当前播放）
  - `autoPlayNewQuestion`: 题目切换时的自动播放（会停止当前播放并开始新播放）
- 重构了播放逻辑，提取出通用的 `startSpeech` 函数
- 添加了智能播放控制，区分不同场景的播放需求

#### UniversalGamePage.tsx
- 添加了 `audioTTSRef` 引用，用于控制音频播放按钮
- 添加了 `hasAutoPlayed` 状态，防止重复自动播放
- 在题目切换时重置自动播放状态
- 添加了自动播放逻辑的 useEffect 钩子
- 使用 `autoPlayNewQuestion` 方法进行题目切换时的自动播放

### 2. 自动播放逻辑

```typescript
// 音频题干自动播放逻辑
useEffect(() => {
    // 只在音频题干模式下且未自动播放过时自动播放
    if (quizState.settings.questionType === 'audio' && currentWord && audioTTSRef.current && !hasAutoPlayed) {
        console.log('🔊 [UniversalGamePage] 准备自动播放音频题干，题目索引:', quizState.currentQuestionIndex);
        
        // 延迟一小段时间确保组件完全渲染
        const timer = setTimeout(() => {
            if (audioTTSRef.current) {
                console.log('🔊 [UniversalGamePage] 题目切换，执行自动播放新题目');
                audioTTSRef.current.autoPlayNewQuestion(); // 使用autoPlayNewQuestion停止旧播放并开始新播放
                setHasAutoPlayed(true);
            }
        }, 500);

        return () => clearTimeout(timer);
    }
}, [quizState.currentQuestionIndex, quizState.settings.questionType, currentWord, hasAutoPlayed]);
```

### 3. 智能播放控制

```typescript
// 手动播放（会停止当前播放）
const handlePlay = () => {
  if (isPlaying) {
    window.speechSynthesis.cancel();
    setIsPlaying(false);
    return;
  }
  startSpeech(true); // 停止之前的播放并开始新的播放
};

// 自动播放（不会停止当前播放）
const autoPlay = () => {
  if (isPlaying) {
    console.log('🔊 已在播放中，跳过自动播放');
    return;
  }
  startSpeech(false); // 不停止当前播放，直接开始播放
};

// 题目切换时的自动播放（会停止当前播放）
const autoPlayNewQuestion = () => {
  console.log('🔊 题目切换，停止旧播放并开始新播放');
  startSpeech(true); // 停止当前播放并开始新的播放
};
```

### 3. 触发条件

自动播放会在以下条件同时满足时触发：
1. `questionType` 为 `'audio'`（音频题干模式）
2. `currentWord` 存在（当前题目已加载）
3. `audioTTSRef.current` 存在（TTS按钮组件已渲染）
4. `!hasAutoPlayed`（当前题目尚未自动播放过）

### 4. 防重复播放机制

- 使用 `hasAutoPlayed` 状态跟踪当前题目是否已自动播放
- 在题目切换时（`currentQuestionIndex` 变化）重置 `hasAutoPlayed` 为 `false`
- 确保每个题目只自动播放一次

### 5. 延迟播放

- 使用 500ms 延迟确保组件完全渲染后再播放
- 避免在组件还未完全加载时尝试播放导致的错误

## 用户体验改进

1. **无缝体验**：用户进入音频题干时无需手动点击播放按钮
2. **智能播放控制**：
   - 自动播放不会中断正在进行的播放
   - 用户点击选项或提交答案时不会停止当前播放
   - 手动点击播放按钮时会停止当前播放并开始新的播放
3. **避免重复播放**：同一题目不会重复自动播放
4. **兼容性好**：不影响文本题干的正常使用
5. **问题修复**：
   - 修复了点击下一题时新题目不自动播放的问题
   - 修复了用户交互导致语音停止的问题

## 测试覆盖

创建了 `audio-autoplay.test.ts` 测试文件，覆盖以下场景：
- 音频题干模式下应该自动播放
- 非音频题干模式下不应该自动播放
- 同一题目只自动播放一次
- 题目切换时重置自动播放状态
- 手动播放和自动播放的区别行为
- 题目切换时停止旧播放并开始新播放的行为

## 兼容性

- 保持与现有功能的完全兼容
- 不影响文本题干的使用
- 不改变手动播放控制的行为
- 支持所有现有的TTS设置和配置

## 技术要点

1. **React Refs**: 使用 `useRef` 和 `forwardRef` 实现组件间通信
2. **状态管理**: 合理使用 `useState` 管理自动播放状态
3. **副作用处理**: 使用 `useEffect` 监听题目变化并触发自动播放
4. **内存管理**: 正确清理定时器避免内存泄漏
5. **类型安全**: 使用 TypeScript 接口确保类型安全

## 未来扩展

可以考虑添加以下功能：
- 自动播放开关设置
- 自动播放延迟时间配置
- 自动播放音量控制
- 播放完成后的回调处理

## 问题修复详情

### 修复前的问题

1. **问题1**：点击下一题时，前面题目停止但新题目不会自动播放
   - **原因**：`handlePlay` 方法总是先调用 `cancel()` 停止当前播放
   - **现象**：用户快速切换题目时，新题目不会自动播放

2. **问题2**：点击选项时会停止朗读
   - **原因**：用户交互可能触发组件重新渲染，导致语音停止
   - **现象**：用户在听题目时点击选项，语音会中断

3. **问题3**：提交填空答案时会停止朗读
   - **原因**：同问题2，用户交互导致语音中断
   - **现象**：用户在听题目时输入答案，语音会中断

### 修复方案

1. **引入智能播放控制**：
   - 新增 `autoPlay` 方法，专门用于自动播放
   - `autoPlay` 不会停止当前正在播放的语音
   - `handlePlay` 保持原有行为，用于手动控制

2. **改进播放逻辑**：
   ```typescript
   // 修复前：总是停止当前播放
   const handlePlay = () => {
     window.speechSynthesis.cancel(); // 总是停止
     // ... 开始新播放
   };

   // 修复后：区分手动和自动播放
   const autoPlay = () => {
     if (isPlaying) return; // 如果正在播放，跳过
     startSpeech(false); // 不停止当前播放
   };

   const handlePlay = () => {
     if (isPlaying) {
       window.speechSynthesis.cancel(); // 手动点击时停止
       return;
     }
     startSpeech(true); // 停止并开始新播放
   };
   ```

3. **优化自动播放触发**：
   - 使用 `autoPlay` 而不是 `handlePlay` 进行自动播放
   - 添加详细的调试日志便于问题排查
   - 改进状态管理和清理逻辑

### 修复后的行为

1. **题目切换**：新题目会正确自动播放，会停止旧题目的播放并开始新题目的播放
2. **用户交互**：点击选项或提交答案时不会中断正在播放的语音
3. **手动控制**：用户点击播放按钮时仍可正常控制播放/停止

## 使用场景示例

### 场景1：正常题目切换
```
用户进入音频题干 → 自动播放开始 → 用户听完后点击下一题 → 停止旧播放，新题目自动播放
```

### 场景2：听题时选择答案
```
用户进入音频题干 → 自动播放开始 → 用户在播放过程中点击选项 → 播放继续，不中断
```

### 场景3：听题时填写答案
```
用户进入音频题干 → 自动播放开始 → 用户在播放过程中输入答案 → 播放继续，不中断
```

### 场景4：手动控制播放
```
用户进入音频题干 → 自动播放开始 → 用户点击播放按钮 → 当前播放停止 → 用户再次点击 → 重新开始播放
```

### 场景5：快速题目切换
```
用户进入音频题干 → 自动播放开始 → 用户在播放过程中点击下一题 → 立即停止当前播放并开始新题目播放
```